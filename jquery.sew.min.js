(function(t,e,i){function s(e,i){this.element=e,this.$element=t(e),this.$itemList=t(s.MENU_TEMPLATE),this.options=t.extend({},h,i),this.reset(),this._defaults=h,this._name=o,this.expression=RegExp("(?:^|\\b|\\s)"+this.options.token+"([\\w.]* ?[\\w.]*)$"),this.cleanupHandle=null,this.init()}var n=function(t,e){t.text(e.val)},o="sew",h=(e.document,{token:"@",elementFactory:n,values:[],unique:!1,repeat:!0});s.MENU_TEMPLATE="<div class='-sew-list-container' style='display: none; position: absolute;'><ul class='-sew-list'></ul></div>",s.ITEM_TEMPLATE='<li class="-sew-list-item"></li>',s.KEYS=[40,38,13,27,9],s.prototype.init=function(){1>this.options.values.length||this.$element.bind("keyup",t.proxy(this.onKeyUp,this)).bind("keydown",t.proxy(this.onKeyDown,this)).bind("focus",t.proxy(this.renderElements,this,this.options.values)).bind("blur",t.proxy(this.remove,this))},s.prototype.reset=function(){this.options.unique&&(this.options.values=s.getUniqueElements(this.options.values)),this.index=0,this.matched=!1,this.dontFilter=!1,this.lastFilter=i,this.filtered=this.options.values.slice(0)},s.prototype.next=function(){this.index=(this.index+1)%this.filtered.length,this.hightlightItem()},s.prototype.prev=function(){this.index=(this.index+this.filtered.length-1)%this.filtered.length,this.hightlightItem()},s.prototype.select=function(){this.replace(this.filtered[this.index].val),this.$element.trigger("mention-selected",this.filtered[this.index]),this.hideList()},s.prototype.remove=function(){this.$itemList.fadeOut("slow"),this.cleanupHandle=e.setTimeout(t.proxy(function(){this.$itemList.remove()},this),1e3)},s.prototype.replace=function(t){var e=this.$element.getCursorPosition(),i=1===e?"":" ",s=this.getText(),n=s.substring(0,e);n=n.replace(this.expression,i+this.options.token+t);var o=s.substring(e,s.length),h=o.match(/^\s/)?"":" ",l=n+h+o;this.setText(l),this.$element.setCursorPosition(n.length+1)},s.prototype.hightlightItem=function(){this.$itemList.find(".-sew-list-item").removeClass("selected");var t=this.$itemList.find(".-sew-list-item").parent(),e=this.filtered[this.index].element.addClass("selected"),i=e.position().top;t.scrollTop(t.scrollTop()+i)},s.prototype.renderElements=function(e){t("body").append(this.$itemList);var i=this.$itemList.find("ul").empty();e.forEach(t.proxy(function(e,n){var o=t(s.ITEM_TEMPLATE);this.options.elementFactory(o,e),e.element=o.appendTo(i).bind("click",t.proxy(this.onItemClick,this,e)).bind("mouseover",t.proxy(this.onItemHover,this,n))},this)),this.index=0,this.hightlightItem()},s.prototype.displayList=function(){if(this.filtered.length){this.$itemList.show();var t=this.$element,e=this.$element.offset(),i=t.getCaretPosition();this.$itemList.css({left:e.left+i.left,top:e.top+i.top})}},s.prototype.hideList=function(){this.$itemList.hide(),this.reset()},s.prototype.filterList=function(e){if(e!=this.lastFilter){this.lastFilter=e,this.$itemList.find(".-sew-list-item").remove();var i=this.options.values,s=this.filtered=i.filter(t.proxy(function(t){var i=RegExp("\\W*"+this.options.token+t.val+"(\\W|$)");return!this.options.repeat&&this.getText().match(i)?!1:""===e||t.val.toLowerCase().indexOf(e.toLowerCase())>=0||(t.meta||"").toLowerCase().indexOf(e.toLowerCase())>=0},this));s.length?(this.renderElements(s),this.$itemList.show()):this.hideList()}},s.getUniqueElements=function(t){var e=[];return t.forEach(function(t){var i=e.map(function(t){return t.val}).indexOf(t.val)>=0;i||e.push(t)}),e},s.prototype.getText=function(){return this.$element.val()||this.$element.text()},s.prototype.setText=function(e){this.$element.prop("tagName").match(/input|textarea/i)?this.$element.val(e):(e=t("<span>").text(e).html().replace(/\s/g,"&nbsp"),this.$element.html(e))},s.prototype.onKeyUp=function(){var t=this.$element.getCursorPosition(),e=this.getText().substring(0,t),s=e.match(this.expression);return!s&&this.matched?(this.matched=!1,this.dontFilter=!1,this.hideList(),i):(s&&!this.matched&&(this.displayList(),this.lastFilter="\n",this.matched=!0),s&&!this.dontFilter&&this.filterList(s[1]),i)},s.prototype.onKeyDown=function(t){var e=this.$itemList.is(":visible");if(e&&!(0>s.KEYS.indexOf(t.keyCode))){switch(t.keyCode){case 9:case 13:this.select();break;case 40:this.next();break;case 38:this.prev();break;case 27:this.$itemList.hide(),this.dontFilter=!0}t.preventDefault()}},s.prototype.onItemClick=function(t){this.cleanupHandle&&e.clearTimeout(this.cleanupHandle),this.replace(t.val),this.$element.trigger("mention-selected",this.filtered[this.index]),this.hideList()},s.prototype.onItemHover=function(t){this.index=t,this.hightlightItem()},t.fn[o]=function(e){return this.each(function(){t.data(this,"plugin_"+o)||t.data(this,"plugin_"+o,new s(this,e))})}})(jQuery,window);